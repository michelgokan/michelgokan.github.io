name: Update contribution numbers

on:
  schedule:
    - cron: "7 3 * * *"    # daily, 03:07 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch contributions via GraphQL
        id: fetch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const from = new Date();
            from.setFullYear(from.getFullYear() - 1);
            const to = new Date();

            const query = `
              query($from: DateTime!, $to: DateTime!) {
                viewer {
                  login
                  contributionsCollection(from: $from, to: $to) {
                    contributionCalendar { totalContributions }
                    restrictedContributionsCount
                    totalCommitContributions
                    totalIssueContributions
                    totalPullRequestContributions
                    totalPullRequestReviewContributions
                  }
                }
              }`;

            const res = await github.graphql(query, {
              from: from.toISOString(),
              to: to.toISOString()
            });

            const cc = res.viewer.contributionsCollection;
            const payload = {
              login: res.viewer.login,
              since: from.toISOString(),
              until: to.toISOString(),
              totalCalendar: cc.contributionCalendar.totalContributions,
              restrictedContributionsCount: cc.restrictedContributionsCount,
              commits: cc.totalCommitContributions,
              prs: cc.totalPullRequestContributions,
              issues: cc.totalIssueContributions,
              reviews: cc.totalPullRequestReviewContributions,
              generatedAt: new Date().toISOString()
            };

            const fs = require('fs');
            fs.writeFileSync('contrib.json', JSON.stringify(payload, null, 2));

      - name: Commit JSON
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update contrib.json"
          file_pattern: contrib.json
